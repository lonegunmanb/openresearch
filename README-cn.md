# OpenResearch：深度研究多代理系统

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

OpenResearch 是一个 AI 驱动的自主研究系统，它编排多个专业化代理来对复杂主题进行全面研究。给定一个研究问题，系统会自动搜索网络、收集信息、检测冲突，并生成一份引用规范的研究报告。

> ⚠️ **免责声明**：本项目仅是一个 **个人学习项目**，创建的唯一目的是探索 Deep Research 的原理以及 AI Agent 的工作流程。**这并非为了商业使用。**
>
> 本项目中涉及某些网站（如 Z-Library、Sci-Hub），纯粹是为了简化信息获取、验证算法和工作流可行性的手段。**这并不代表我同意侵犯版权。**
>
> **请勿用于学习以外的目的。**

## 目录

- [前置条件](#前置条件)
- [架构概述](#架构概述)
- [代理角色](#代理角色)
- [执行者如何收集信息](#执行者如何收集信息)
- [动态 Top-K 饱和度检测](#动态-top-k-饱和度检测)
- [反思者如何检测冲突](#反思者如何检测冲突)
- [基于证据权重的冲突解决](#基于证据权重的冲突解决)
- [闭世界假设：消除幻觉](#闭世界假设消除幻觉)
- [文件结构](#文件结构)
- [使用方法](#使用方法)

---

## 前置条件

在使用 OpenResearch 之前，请确保已安装以下依赖：

### 必需

| 依赖 | 版本 | 说明 |
|------|------|------|
| **Go** | ≥ 1.21 | 用于构建和运行编排器 |

### AI 代理 CLI（以下任选其一）

| CLI 工具 | 推荐程度 | 备注 |
|----------|----------|------|
| **GitHub Copilot CLI** | ✅ **推荐** | 已完整测试并验证 |
| Gemini CLI | ⚠️ 实验性 | 未完整测试 |
| Claude Code | ⚠️ 实验性 | 未完整测试 |

> **注意**：我们推荐使用 **GitHub Copilot CLI**，因为它已经过本系统的充分测试。其他 CLI 工具（Gemini CLI 和 Claude Code）理论上应该可以工作，但尚未经过广泛测试。

### 研究前准备（重要！）

> **💡 提示**：在启动研究会话之前，强烈建议在项目目录下手动启动 CLI agent，并让 agent 预先登录关键网站。这可以确保自动化研究过程中的顺畅访问。

**建议登录的网站：**

| 网站 | URL | 用途 |
|------|-----|------|
| Google | `google.com` | 网络搜索 |
| Google 学术 | `scholar.google.com` | 学术论文 |
| YouTube | `youtube.com` | 视频转录 |
| NotebookLM | `notebooklm.google.com` | 电子书分析 |
| Z-Library | `z-lib.io` | 电子书下载 |
| Sci-Hub | `sci-hub.ru` | 学术论文获取 |

```bash
# 示例：启动 agent 并登录网站
cd /path/to/your/research/project
copilot

# 然后让 agent 执行：
# "请打开浏览器并登录 google.com"
```

> ⚠️ **安全警告**：你的登录信息会被保存在当前目录下的 `browser_profile` 和 `tmp` 目录中，务必不要泄露！研究完成后建议删除这些目录。

---

## 架构概述

系统采用 **多代理流水线架构**，包含四个独立阶段：

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              编排器 (ORCHESTRATOR)                               │
│              管理状态转换、调度代理、监控进度                                      │
└───────────────┬───────────────┬───────────────┬───────────────┬─────────────────┘
                │               │               │               │
                ▼               ▼               ▼               ▼
         ┌──────────┐    ┌──────────────┐  ┌───────────┐  ┌─────────────┐
         │  规划者   │ →  │   研究主管   │→ │   反思者   │→ │    综合者   │
         │ PLANNER  │    │  RESEARCH-   │  │ REFLECTOR │  │ SYNTHESIZER │
         │          │    │  SUPERVISOR  │  │           │  │             │
         │  创建    │    │   调度执行者  │  │  质量门控  │  │  生成报告   │
         │ task.md  │    │              │  │           │  │ report.md  │
         └──────────┘    └──────────────┘  └───────────┘  └─────────────┘
                                │
                    ┌───────────┼───────────┐
                    ▼           ▼           ▼
              ┌──────────┐┌──────────┐┌──────────┐
              │ 执行者    ││ 执行者    ││ 执行者    │
              │   E1     ││   E2     ││   E3     │
              └──────────┘└──────────┘└──────────┘
```

### 工作流阶段

| 阶段 | 代理 | 输入 | 输出 |
|------|------|------|------|
| **1. 规划** | 规划者 | 用户的研究问题 | 包含研究 DAG 的 `task.md` |
| **2. 研究** | 研究主管 + 执行者 | `task.md` | 填充后的知识图谱 |
| **3. 反思** | 反思者 | 知识图谱 | 决策：继续 / 综合 / 错误 |
| **4. 综合** | 综合者 | 完整的知识图谱 | `report.md` |

---

## 代理角色

### 规划者 (Planner)
- 将研究问题分解为子问题，形成 **有向无环图 (DAG)**
- 定义研究维度和预期来源类型
- 创建包含完整研究计划的 `task.md`

### 研究主管 (Research-Supervisor)
- 管理执行阶段
- 并行调度多个执行者代理
- 收集结果并更新 `task.md`

### 执行者 (Executor)
- 使用浏览器自动化 (Playwright) 执行实际的网络搜索
- 下载并归档来源到 `assets/`
- 提取带来源引用的事实
- 使用 **动态 Top-K** 算法判断信息何时饱和

### 反思者 (Reflector)
- 评估研究完整性
- 检测收集的事实之间的冲突
- 执行幻觉检查（来源可追溯性）
- 决定是否需要更多研究

### 综合者 (Synthesizer)
- 将知识图谱转化为连贯的报告
- 在 **闭世界假设** 下运行
- 确保每个声明都有来源引用

---

## 执行者如何收集信息

执行者采用 **分层委托模型**，进行迭代批处理：

### 搜索方法优先级（回退链）

```
优先级 1：MCP Playwright + Google/Bing/Scholar
     │
     │ 失败时（验证码、被阻止、超时）
     ▼
优先级 2：Serper-Search API → 然后用 Playwright 访问 URL
     │
     │ 失败时
     ▼
优先级 3：内置 web_search 工具（最后手段）
```

### 执行周期

每个执行者以迭代批次运行：

```
┌─────────────────────────────────────────────────────────────┐
│                   批次 N：规划阶段                            │
│  1. 构建 3-5 个高精度搜索查询                                 │
│  2. 确定 k 值（每个查询的文档数）                              │
│  3. 识别需要专家代理的来源                                    │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   批次 N：调度阶段                            │
│  1. 生成子执行者进行网络搜索                                   │
│  2. 生成专家代理处理复杂检索：                                 │
│     - YouTube 转录代理                                       │
│     - 论文下载代理                                           │
│     - 电子书 + NotebookLM 代理                               │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   批次 N：评估阶段                            │
│  1. 聚合来自所有子代理的事实                                   │
│  2. 去重并验证来源                                           │
│  3. 检查饱和度信号（见下文）                                   │
│  4. 决策：停止或继续下一批次                                   │
└─────────────────────────────────────────────────────────────┘
```

### 资源存储

所有下载的内容都会本地归档以便追溯：

| 内容类型 | 存储路径 |
|----------|----------|
| 网页 | `assets/web/` |
| PDF 文档 | `assets/pdf/` |
| 学术论文 | `assets/pdf/` |
| YouTube 转录 | `assets/transcripts/` |
| 图片 | `assets/images/` |
| 电子书 | `assets/ebook/` |

---

## 动态 Top-K 饱和度检测

执行者使用 **动态 Top-K 算法** 来判断何时收集了足够的信息。这既能防止研究不足（遗漏关键信息），也能防止过度研究（在冗余数据上浪费资源）。

### 算法参数

| 参数 | 默认值 | 描述 |
|------|--------|------|
| `k_initial` | 5 | 初始批次大小（每个查询的文档数） |
| `k_expand` | 10 | 信息不足时扩展的批次大小 |
| `min_batches` | 2 | 允许提前停止前的最小批次数 |
| `max_batches` | 10 | 最大批次数（硬限制） |
| `saturation_threshold` | 2 | 连续无新信息的批次数达到此值触发停止 |
| `min_tier1_sources` | 3 | 所需的最小权威来源数 |

### 饱和度检测逻辑

```python
saturation_counter = 0

for batch in range(1, max_batches + 1):
    results = execute_batch(k=k_initial if batch <= 2 else k_expand)
    
    new_relevant_info = evaluate_results(results)
    
    if new_relevant_info:
        saturation_counter = 0  # 重置计数器
    else:
        saturation_counter += 1  # 递增计数器
    
    # 检查所有停止条件
    if (batch >= min_batches and
        saturation_counter >= saturation_threshold and
        all_dimensions_covered() and
        tier1_sources >= min_tier1_sources):
        break  # 信息已饱和
```

### 什么算作"新的相关信息"？

| 新信息（重置计数器） | 非新信息（递增计数器） |
|----------------------|----------------------|
| 回答未覆盖维度的事实 | 已捕获的冗余事实 |
| 尚未捕获的定量数据 | 来源重复之前的信息 |
| 新的权威来源 | 仅有离题或低质量的结果 |
| 与现有事实矛盾/补充的信息 | 来自同一来源的重复内容 |

### 动态 K 值调整

```
批次 1-2：k = k_initial（5 个文档）
          建立基线知识

批次 3+： 如果发现新信息：
              k = k_initial（继续正常节奏）
          否则：
              k = k_expand（10 个文档，撒更大的网）
```

---

## 反思者如何检测冲突

反思者是研究和综合之间的 **质量门控**。它执行五个强制性评估阶段：

### 评估阶段

1. **完整性检查** - 所有研究维度是否得到充分覆盖？
2. **冲突检测** - 是否有事实相互矛盾？
3. **幻觉检查** - 每个事实是否都有有效来源？
4. **差距分析** - 还缺少哪些关键信息？
5. **质量评估** - 研究质量的总体评分

### 冲突检测过程

反思者扫描知识图谱以查找矛盾信息：

```markdown
### 检测到的冲突

| ID | 主题 | 事实 A | 事实 B | 来源 | 严重性 |
|----|------|--------|--------|------|--------|
| CONF-1 | 金价 | [Fact-012]: 黄金 $2,800/盎司 | [Fact-045]: 黄金 $2,650/盎司 | S03 vs S07 | 高 |
| CONF-2 | 美联储利率 | [Fact-023]: 预期降息 2 次 | [Fact-067]: 预期降息 3 次 | S05 vs S12 | 中 |
```

### 严重性分类

| 严重性 | 标准 | 行动 |
|--------|------|------|
| **高** | 核心声明矛盾，影响主要结论 | 创建 C* 冲突解决任务 |
| **中** | 次要声明不同 | 标记用于综合，并给出建议的表述方式 |
| **低** | 轻微差异 | 在报告中简要说明 |

---

## 基于证据权重的冲突解决

当检测到冲突时，反思者使用 **证据权重算法** 来确定应该信任哪个来源。

### 权重公式

```
W(来源) = 0.6 × 权威性 + 0.4 × 时效性
```

### 权威性评分

| 来源类型 | 权威性评分 |
|----------|------------|
| .gov / .edu / 官方政府网站 | 1.0 |
| 学术期刊（同行评审） | 0.9 |
| 行业报告（WGC、IMF、BLS 等） | 0.8 |
| 知名新闻媒体（路透社、彭博社） | 0.7 |
| 博客 / 论坛 / 社交媒体 | 0.5 |

### 时效性评分

| 新近程度 | 时效性评分 |
|----------|------------|
| 在研究时间范围内 | 1.0 |
| 1 年前 | 0.8 |
| 2 年以上 | 0.6 |
| 明显过时 | 0.3 |

### 冲突解决示例

```markdown
**冲突**：2026 年 1 月的金价

来源 S03（世界黄金协会报告，2026 年 1 月）：
  - 权威性：0.8（行业报告）
  - 时效性：1.0（当前）
  - W(S03) = 0.6 × 0.8 + 0.4 × 1.0 = 0.88

来源 S07（博客文章，2025 年 12 月）：
  - 权威性：0.5（博客）
  - 时效性：0.8（1 个月前）
  - W(S07) = 0.6 × 0.5 + 0.4 × 0.8 = 0.62

解决方案：采用 S03（W=0.88 > 0.62）
```

### C* 任务输出格式

对于高严重性冲突，会创建专门的 C* 任务：

```markdown
# 冲突解决：C1

## 解决决策
**采用**：S03（Fact-012）
**理由**：世界黄金协会是具有当前数据的权威行业来源，
        而博客文章缺乏机构可信度。

## 报告呈现指导
> "关于 2026 年 1 月的金价，世界黄金协会报告为 $2,800/盎司 [S03]，
> 而一些在线来源引用 $2,650/盎司 [S07]。鉴于世界黄金协会的机构权威性，
> 本报告采用其数据。"
```

---

## 闭世界假设：消除幻觉

综合者在严格的 **闭世界假设 (CWA)** 下运行，以防止 AI 幻觉污染研究报告。

### 什么是闭世界假设？

> **只有知识图谱中明确存在的事实才被认为是真实的。**
> 
> 如果某些信息不在收集的研究数据中，那么就本报告而言，它不存在。

### 实现方式

```
┌─────────────────────────────────────────────────────────────────┐
│                      综合者约束条件                               │
│                                                                  │
│  ✅ 允许：                                                       │
│     - 使用知识图谱中的事实                                        │
│     - 引用来源注册表中的来源                                      │
│     - 陈述从收集的事实中得出的逻辑推断                             │
│                                                                  │
│  ❌ 禁止：                                                       │
│     - 使用 LLM 训练数据中的知识                                   │
│     - 做出没有 [SXX] 引用的声明                                   │
│     - 用"常识"填补空白                                           │
│     - 静默解决矛盾                                               │
└─────────────────────────────────────────────────────────────────┘
```

### 引用索引构建

在撰写之前，综合者会构建引用索引：

```markdown
| 事实 ID | 陈述 | 来源 ID | 已验证 |
|---------|------|---------|--------|
| Fact-001 | 美联储维持利率在 4.5% | [S01] | ✅ |
| Fact-002 | 黄金达到 $2,800/盎司 | [S03, S08] | ✅ |
| Fact-003 | [未找到来源] | - | ❌ 错误 |
```

**如果任何事实缺少有效来源 → 综合将被阻止，直到修正。**

### 处理缺失信息

当知识图谱不包含完全回答研究问题所需的信息时：

```markdown
## 局限性与注意事项

1. **数据空白**：未收集到关于 [特定方面] 的信息。
   当前数据未覆盖此维度。

2. **单一来源声明**：[Fact-045] 仅依赖于 [S12]。
   建议进行独立验证。

3. **时间范围**：分析主要覆盖 [时间范围]。
   未研究更早/更晚的时期。
```

### 引用密度要求

每 1-2 句话必须至少有一个来源引用：

**✅ 正确：**
> 美联储在 2026 年 1 月维持利率在 4.5% [S01]，同时暗示可能在第二季度降息 [S03]。
> 市场预期目前定价年底前降息 2-3 次 [S05][S08]。

**❌ 错误：**
> 随着通胀降温和经济放缓迹象显现，预计美联储今年将降息。

---

## 文件结构

```
openresearch/
├── task.md                    # 研究状态（DAG、知识图谱、来源）
├── report.md                  # 最终综合报告
├── input.md                   # 用户的研究请求
├── assets/
│   ├── web/                   # 归档的网页
│   ├── pdf/                   # 下载的 PDF
│   ├── ebook/                 # 电子书
│   ├── images/                # 截图
│   └── audio/                 # 音频文件
├── logs/
│   ├── planner.log
│   ├── research_supervisor.log
│   ├── E1.log, E2.log, ...    # 执行者日志
│   ├── E1_result.md, ...      # 执行者结果
│   ├── reflector.log
│   └── synthesizer.log
├── prompts/
│   └── deep-research/
│       ├── planner.md
│       ├── executor.md
│       ├── reflector.md
│       ├── synthesizer.md
│       └── research-supervisor.md
└── cmd/
    └── deepresearch/
        └── main.go            # 编排器
```

---

## 使用方法

```bash
# 基本用法：带研究问题
deepresearch --model claude-opus-4.5 -p "研究 AI 对 2025 年软件开发工作的影响"

# 使用输入文件
deepresearch --model claude-opus-4.5 -f "input.md"

# 交互模式（允许澄清问题）
deepresearch --model claude-opus-4.5
```

---

## 核心设计原则

| 原则 | 实现方式 |
|------|----------|
| **来源可追溯性** | 每个事实都有 [SXX] 引用，指向归档的来源 |
| **冲突保留** | 矛盾永远不会被静默解决；在报告中明确呈现 |
| **禁止捏造** | 闭世界假设防止 LLM 幻觉 |
| **物理落地** | 所有来源归档到本地 `assets/` 以供审计 |
| **迭代优化** | 反思循环确保综合前的研究质量 |

---

## 许可证

MIT 许可证 - 详见 [LICENSE](LICENSE)。
